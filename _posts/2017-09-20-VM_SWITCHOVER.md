---
layout: post
title: 从连不上数据库到更换磁盘，软件到硬件的诊断
date: 2017-09-20
categories: OracleDiagnosis
tags: [Oracle,Diagnosis]
description: 从连不上数据库到更换磁盘。
---

分享一起故障处理。。。

一大早上接到客户电话，反应数据库监听可能存在问题，应用连接不上数据库，业务中断，经过排查及故障处理，排查软件及硬件问题，协调硬件工程师奔赴现场，远程协作，最终将故障点恢复，完成数据库恢复，成功启动，业务得以继续平稳运行。

这里大概简述一下处理的思路流程（环境是Linux+Oracle11g单机，安装在虚拟化上）：

1. 远程连接到客户的服务器，发现并不是监听的问题，而是数据库没有启动。检查数据库的alert日志，没有发现实例关闭的信息，凌晨之后，alert没有更新信息。（这里说明数据库可能是意外宕机）

2. 查询操作系统message，发现凌晨到上午9点期间几乎没有信息。（这里面说明可能是主机意外宕机）

3. 查看last命令，发现操作系统在9月19日0点23分重启过，直到早上8点59分，才有用户（root）连接到服务器（推测是应用连接不到数据库，进而登陆服务器主机进行查看）

4. 尝试启动数据库，观察alert日志，发现数据库需要进行实例恢复（在alter database open的时候，有crash recovery of xxxxxx字样，并且下面会伴有read xxxx redo, xxxx data blocks need recovery），且恢复时间比较长，查看iostat -x 2 5，发现oradata所在磁盘很繁忙（%util），但是读写很低，几乎没有。（这里已经怀疑到虚拟化的底层磁盘的问题了）

5. 请客户登陆虚拟化平台进行查看，发现虚拟化软件通过“vmware-ha”功能，在0点左右进行过切换，虚拟化报错为磁盘出现内存和硬盘报错（这个过程造成了服务器的异常关闭，导致数据库的异常关闭）

6. 至此已经基本定位为底层磁盘的问题，协调联系公司的硬件工程师前往客户机房进行硬盘故障处理，待硬件工程师在客户现场将报错的hba卡修复之后，IO问题恢复，继而数据库问题恢复。

7. 测试读写正常，客户业务恢复。并持续跟进一段时间，在当晚手动做了数据库全备份。


### 针对这次的故障，小w有几点建议：

1. 单点故障：如今天出现的问题，硬件故障导致数据库受到严重影响。所以强烈建议采用oracle自带的rac架构，或者搭建data guard等。

2. 虚拟化：今天的问题主要是由于虚拟化的特性vmware-ha在故障的时候进行切换导致的。他在切换的时候，相当于将当前的服务器进行强制断电操作。数据库等于是异常关闭。这样在启动的时候需要进行实例恢复，而且容易引发坏块，数据丢失等问题。所以针对这个我个人建议在虚拟化上面虽然使用很方便，但是真的不建议布置数据库，应用倒是可以考虑放在虚拟化上面。

3. 资源争用及损耗：虚拟化上面，从物理磁盘到映射给主机的虚拟磁盘，这个过程无形中会损耗一部分资源。并且如果是同一块物理盘映射给2个以上虚拟机，还会引发资源争用。






![小w](https://wx2.sinaimg.cn/mw1024/891ecf4fly1fr361nvrcnj207w07sad7.jpg)

###### 博文内容为小w原创，部分内容引用自官方资料，如转载请注明出处。^_^

###### 感谢关注w的小站，本小站将不定期(完全看心情～)更新分享技术知识，欢迎阅读，网址：www.itwwb.com



